<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hotel Listing</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="container my-5">
      <div class="row">
        <div class="col-md-4">
          <label for="districtFilter">Filter by District</label>
          <select id="districtFilter" class="form-control">
            <option value="">All Districts</option>
          </select>
        </div>

        <div class="col-md-4">
          <label for="searchByName">Search by Name</label>
          <input
            type="text"
            id="searchByName"
            class="form-control"
            placeholder="Enter hotel name"
          />
        </div>

        <div class="col-md-4">
          <label>&nbsp;</label>
          <button id="filterButton" class="btn btn-primary btn-block">
            Filter
          </button>
        </div>
      </div>

      <div class="row mt-4" id="resultsContainer"></div>

      <div class="row mt-4">
        <button id="loadMoreButton" class="btn btn-secondary mx-auto">
          Load More
        </button>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const resultsContainer = document.getElementById("resultsContainer");
        const districtFilter = document.getElementById("districtFilter");
        const searchByName = document.getElementById("searchByName");
        const filterButton = document.getElementById("filterButton");

        let selectedDistrict = "";
        let searchName = "";

        // Fetch and populate district filter dropdown
        async function fetchDistricts() {
          try {
            const response = await fetch(
              "http://127.0.0.1:8000/hotel/districts/"
            );
            if (!response.ok) throw new Error("Failed to fetch district data");
            const districts = await response.json();
            districts.forEach((district) => {
              const option = document.createElement("option");
              option.value = district.slug;
              option.textContent = district.district_name;
              districtFilter.appendChild(option);
            });
          } catch (error) {
            console.error("Error fetching districts:", error);
          }
        }

        // Fetch hotels with filter and pagination
        async function fetchAllHotels(url) {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Failed to fetch hotels data");
            const data = await response.json();

            displayHotels(data.results);

            // Fetch the next page if available
            if (data.next) {
              await fetchAllHotels(data.next); // Recursive call to fetch the next page
            }
          } catch (error) {
            resultsContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
          }
        }

        // Display hotels in the DOM
        function displayHotels(hotelsList) {
          if (hotelsList.length === 0 && resultsContainer.innerHTML === "") {
            resultsContainer.innerHTML =
              '<div class="alert alert-warning">No hotels found.</div>';
            return;
          }

          hotelsList.forEach((hotel) => {
            const hotelCard = document.createElement("div");
            hotelCard.className = "col-lg-4 col-md-6 mb-4";
            hotelCard.innerHTML = `
                <div class="card">
                    <img src="${hotel.photo}" class="card-img-top" alt="${
              hotel.name
            }">
                    <div class="card-body">
                        <h5 class="card-title">${hotel.name}</h5>
                        <p class="card-text">${truncateText(
                          hotel.description,
                          100
                        )}</p>
                        <p class="card-text"><strong>District:</strong> ${
                          hotel.district_name
                        }</p>
                        <p class="card-text"><strong>Price:</strong> $${
                          hotel.price_per_night
                        }/Night</p>
                        <p class="card-text"><strong>Available Rooms:</strong> ${
                          hotel.available_room
                        }</p>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(hotelCard);
          });
        }

        // Truncate text for display
        function truncateText(text, length) {
          return text.length > length
            ? text.substring(0, length) + "..."
            : text;
        }

        // Apply filters (district and name search)
        function applyFilters() {
          resultsContainer.innerHTML = ""; // Clear previous results
          let apiUrl =
            "http://127.0.0.1:8000/hotel/hotels/?";

          if (selectedDistrict) {
            apiUrl += `district=${selectedDistrict}&`;
          }

          if (searchName) {
            apiUrl += `name=${searchName}&`;
          }

          fetchAllHotels(apiUrl); // Fetch filtered results across all pages
        }

        // Handle the Filter button click
        filterButton.addEventListener("click", function () {
          selectedDistrict = districtFilter.value;
          searchName = searchByName.value;
          applyFilters();
        });

        // Fetch initial data
        fetchDistricts();
        fetchAllHotels(
          "http://127.0.0.1:8000/hotel/hotels/"
        );
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration</title>
    <!-- Include Bootstrap CSS for styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <section class="vh-100 align-content-center align-items-center">
        <div class="container">
            <div class="row d-flex justify-content-center align-items-center">
                <div class="col-md-9 col-lg-6 col-xl-5">
                    <!-- Placeholder image for illustration -->
                    <img src="./img/image.png" class="img-fluid" alt="Sample image">
                </div>
                <div class="col-md-8 col-lg-6 col-xl-4 offset-xl-1">
                    <div class="container">
                        <h2 class="text-center">Register</h2>
                        <div id="error-container" class="alert alert-danger d-none" role="alert"></div>
                        <form id="registrationForm">
                            <div class="form-group mb-3">
                                <input type="text" class="form-control form-control-lg" id="username" placeholder="Enter username" required>
                            </div>
                            <div class="form-group mb-3">
                                <input type="text" class="form-control form-control-lg" id="first_name" placeholder="Enter first name" required>
                            </div>
                            <div class="form-group mb-3">
                                <input type="text" class="form-control form-control-lg" id="last_name" placeholder="Enter last name" required>
                            </div>
                            <div class="form-group mb-3">
                                <input type="email" class="form-control form-control-lg" id="email" placeholder="Enter email" required>
                            </div>
                            <div class="form-group mb-3">
                                <input type="password" class="form-control form-control-lg" id="password" placeholder="Enter password" required>
                            </div>
                            <div class="form-group mb-3">
                                <input type="password" class="form-control form-control-lg" id="confirm_password" placeholder="Confirm password" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg" style="padding-left: 2.5rem; padding-right: 2.5rem;">Register</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Include Bootstrap JS and jQuery for required functionality -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registrationForm = document.getElementById('registrationForm');
            const errorContainer = document.getElementById('error-container');

            registrationForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                // Reset error message
                errorContainer.textContent = '';
                errorContainer.classList.remove('d-block');
                errorContainer.classList.remove('alert-success');
                errorContainer.classList.remove('alert-danger');

                // Get form values
                const username = document.getElementById('username').value.trim();
                const firstName = document.getElementById('first_name').value.trim();
                const lastName = document.getElementById('last_name').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();
                const confirmPassword = document.getElementById('confirm_password').value.trim();

                // Client-side validation
                if (!username || !firstName || !lastName || !email || !password || !confirmPassword) {
                    displayError('Please fill in all fields.');
                    return;
                }

                if (password !== confirmPassword) {
                    displayError('Passwords do not match.');
                    return;
                }

                try {
                    // Check if username or email already exists
                    const usersResponse = await fetch('https://blueskybooking.onrender.com/user/allUser/');
                    if (!usersResponse.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const usersData = await usersResponse.json();

                    const existingUsername = usersData.some(user => user.username === username);
                    const existingEmail = usersData.some(user => user.email === email);

                    if (existingUsername) {
                        displayError('Username already exists');
                        return;
                    }

                    if (existingEmail) {
                        displayError('Email already exists');
                        return;
                    }

                    // Proceed with registration if no existing username or email
                    const registrationData = {
                        username,
                        first_name: firstName,
                        last_name: lastName,
                        email,
                        password
                    };

                    const registrationResponse = await fetch('https://blueskybooking.onrender.com/user/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(registrationData)
                    });

                    if (!registrationResponse.ok) {
                        throw new Error('Registration failed');
                    }

                    const registrationResult = await registrationResponse.json();
                    console.log('Registration successful:', registrationResult);

                    // Display success message
                    displaySuccess('Registration successful! Please login.');

                    // Optionally redirect to success page after registration
                    // window.location.href = 'success.html';

                } catch (error) {
                    console.error('Error during registration:', error);
                    displayError('Error during registration. Please try again later.');
                }
            });

            function displayError(message) {
                errorContainer.textContent = message;
                errorContainer.classList.add('alert', 'alert-danger', 'd-block');
            }

            function displaySuccess(message) {
                errorContainer.textContent = message;
                errorContainer.classList.add('alert', 'alert-success', 'd-block');
            }
        });
    </script>
</body>
</html>
